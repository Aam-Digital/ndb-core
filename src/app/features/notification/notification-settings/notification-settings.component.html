<div class="notifications-container">
  <h1 class="notification-setting-title" i18n>Notifications Settings</h1>
  <div i18n>
    Notifications can remind you of events in the system that are important to
    you. For example, you can set up custom notifications to see when certain
    records are added or changed (e.g. when a new participant has registered
    through a public form; or when a colleague assigned a task to you). These
    notifications are visible in the toolbar and can be sent to you via email or
    push notifications.
  </div>

  <div class="notification-types-container">
    <h3 class="no-margin" i18n>
      <strong>What notifications you receive</strong>
    </h3>
    <div i18n>
      Define rules for events that you want to get notifications for. You can
      add as many rules as you want. Disable a rule temporarily to pause these
      notifications without deleting the conditions completely.
    </div>

    <cdk-accordion class="notification-rules-accordion">
      @for (
        notificationRule of notificationRules.controls;
        track notificationRule;
        let index = $index
      ) {
        <div class="notification-rule-accordion-item">
          <cdk-accordion-item
            #accordionItem="cdkAccordionItem"
            tabindex="0"
            [attr.id]="'accordion-header-' + index"
            [attr.aria-expanded]="accordionItem.expanded"
            [attr.aria-controls]="'accordion-body-' + index"
            class="flex-column justify-space-between align-center notifications-options-container"
          >
            <div
              class="flex-column justify-space-between align-center notification-options-wrapper"
            >
              <div
                class="flex-row justify-content-center align-center notification-rule-option"
              >
                <mat-form-field class="full-width-field">
                  <mat-label i18n>Select an entity type</mat-label>
                  <app-entity-type-select
                    [formControl]="getFormField(index, 'entityType')"
                    (ngModelChange)="
                      updateNotificationEntityField(index, 'entityType')
                    "
                  ></app-entity-type-select>
                </mat-form-field>
                <app-help-button
                  text="A notification type is based on the selected entity. For instance, choosing 'task' will enable notifications for newly created tasks in the system."
                  i18n-text
                ></app-help-button>
              </div>

              <div
                class="flex-row justify-content-center align-center notification-rule-option"
              >
                <app-notification-method-select
                  [selectedNotificationMethod]="[
                    getFormField(index, 'notificationMethod').value,
                  ]"
                  (selectionChange)="updateNotificationCenter($event, index)"
                  class="full-width-field"
                ></app-notification-method-select>
                <app-help-button
                  text="Define a notification method to receive notifications"
                  i18n-text
                ></app-help-button>
              </div>
            </div>

            <div class="flex-row notification-rule-actions">
              <div class="flex-row align-center">
                <mat-slide-toggle
                  [formControl]="getFormField(index, 'enabled')"
                  (change)="enableNotificationRule($event, index)"
                  class="notification-toggle"
                  matTooltip="You can enable or disable notifications. If you do not want to delete this notification rule, you can disable it to 'pause' these notifications."
                  i18n-matTooltip
                ></mat-slide-toggle>
              </div>

              <button
                mat-icon-button
                (click)="confirmRemoveNotificationRule(index)"
                matTooltip="Remove notification rule"
                i18n-matTooltip
              >
                <fa-icon icon="trash"></fa-icon>
              </button>

              <button
                mat-icon-button
                (click)="testNotification()"
                matTooltip="Test notification"
                i18n-matTooltip
              >
                <fa-icon icon="paper-plane"></fa-icon>
              </button>
            </div>

            <button
              mat-icon-button
              [matTooltip]="
                accordionItem.expanded ? 'Collapse section' : 'Expand section'
              "
              i18n-matTooltip
              (click)="accordionItem.toggle()"
            >
              <fa-icon
                [icon]="accordionItem.expanded ? 'chevron-up' : 'chevron-down'"
              ></fa-icon>
            </button>
          </cdk-accordion-item>
          @if (accordionItem.expanded) {
            <div
              class="example-accordion-item-body"
              role="region"
              [style.display]="accordionItem.expanded ? '' : 'none'"
              [attr.id]="'accordion-body-' + index"
              [attr.aria-labelledby]="'accordion-header-' + index"
            >
              <div class="flex-row align-center notification-condition-section">
                <strong>Define Notification Criteria</strong>
                <app-help-button
                  text="You can choose a notification based on the selected entity. For example, if you select 'task', you can create a notification for when a task is assigned to a user."
                  i18n-text
                ></app-help-button>
              </div>
              @for (
                notificationCondition of notificationConditions;
                track notificationCondition;
                let index = $index
              ) {
                <div class="flex-row align-center full-width">
                  <mat-form-field>
                    <mat-label i18n>Select Entity Field</mat-label>
                    <app-entity-field-select
                      [entityType]="this.selectedNotificationEntity"
                    />
                  </mat-form-field>
                  <mat-form-field>
                    <mat-label i18n>Notification condition</mat-label>
                    <app-conditional-filter [formControl]="getFormField(index, 'notificationRuleCondition')" />
                  </mat-form-field>
                  <mat-form-field class="notification-rule-option">
                    <mat-label i18n>Notification condition</mat-label>
                    <input
                      matInput
                      placeholder="Status"
                      i18n-placeholder="Notification condition placeholder"
                    />
                  </mat-form-field>
                </div>
              }
              <div class="flex-row justify-content-center">
                <button
                  mat-stroked-button
                  class="add-new-rule-button"
                  color="accent"
                  (click)="appendNewNotificationCondition($event)"
                  matTooltip="Define another condition of notifications for your user account"
                  i18n-matTooltip
                >
                  <fa-icon
                    aria-label="add element"
                    icon="plus-circle"
                  ></fa-icon>
                  <span i18n class="new-notification-rule"
                    >Add new notification condition</span
                  >
                </button>
              </div>
            </div>
          }
        </div>
      }
    </cdk-accordion>
    <div class="flex-row justify-content-center add-new-notification-rule">
      <button
        mat-stroked-button
        class="add-new-rule-button"
        color="accent"
        (click)="appendNewNotificationRule()"
        matTooltip="Define another type of notifications for your user account"
        i18n-matTooltip
      >
        <fa-icon aria-label="add element" icon="plus-circle"></fa-icon>
        <span i18n class="new-notification-rule"
          >Add new notification rule</span
        >
      </button>
    </div>
  </div>

  <div class="browser-notifications-container">
    <div class="browser-notifications-title">
      <h3 i18n class="no-margin flex-row align-center">
        <strong>Where you receive notifications</strong>
        @if (isPushNotificationEnabled) {
          <div
            class="enabled-text"
            matTooltip="Push notifications are enabled. Youâ€™ll receive real-time updates for important activities."
            i18n-matTooltip
          >
            Enabled
          </div>
        } @else {
          <div
            class="disabled-text"
            matTooltip="Push notifications are disabled. Turn them on in settings to stay informed about updates."
            i18n-matTooltip
          >
            Disabled
          </div>
        }
      </h3>
      <div i18n>
        Notifications are always visible through the bell icon in the toolbar at
        the top of the application. You can enable other ways to get
        notifications sent to you below.
      </div>
    </div>
    <div class="receive-notifications-container">
      <div>
        <div class="flex-row">
          <fa-icon icon="window-maximize"></fa-icon>
          <p class="notification-toggle" i18n>Browser</p>
        </div>
        <div
          class="flex-row align-center justify-space-between browser-notification-list"
        >
          <div class="flex-row align-center">
            <span i18n>Notification Center (in app)</span>
            <app-help-button
              text="View notifications in the app's interface. Click the icon in the top toolbar to see all notifications, including those you already read. The notification center is always available and cannot be disabled."
              i18n-text
            ></app-help-button>
          </div>
        </div>
        <div
          class="flex-row align-center justify-space-between browser-notification-list"
        >
          <div class="flex-row align-center">
            <span i18n>Push notifications</span>
            <app-help-button
              text="A notification on your system (e.g. a normal Android smartphone notification). You see these alerts without needing to open the app."
              i18n-text
            ></app-help-button>
          </div>
          <mat-slide-toggle
            (change)="onEnableNotification($event)"
            [checked]="isPushNotificationEnabled"
          />
        </div>
      </div>

      <div>
        <div class="flex-row">
          <fa-icon icon="envelope"></fa-icon>
          <p class="notification-toggle" i18n>Email</p>
        </div>
        <div
          class="flex-row align-center justify-space-between browser-notification-list"
        >
          <div class="flex-row align-center">
            <span i18n>Email</span>
            <span class="coming-soon-label" i18n>Coming Soon</span>
          </div>
          <mat-slide-toggle disabled></mat-slide-toggle>
        </div>
      </div>
    </div>
  </div>
</div>
