@if (isInDialog()) {
  <div>
    <h2 mat-dialog-title i18n>Edit User Account</h2>
    <app-dialog-close></app-dialog-close>
  </div>
}

<div class="flex-column padding-right-regular padding-left-regular">
  @if (!isProfileMode()) {
    <!-- Creating a new account -->
    @if (creatingNewAccount()) {
      <div class="align-self-start padding-bottom-small">
        <p i18n class="field-hint field-warning">
          There is no user account set up for this user yet. Enable this user to
          log into the app by filling the details below.
        </p>
        @if (!formDisabled()) {
          <button
            mat-raised-button
            type="submit"
            (click)="save()"
            class="invite-button"
            color="accent"
            [class.invite-button-animate]="true"
            i18n
          >
            Create account & send invitation
          </button>
        }
      </div>
    } @else {
      <!-- Actions editing existing account -->
      <div
        class="padding-bottom-small flex-row gap-small align-self-end flex-wrap padding-top-small"
      >
        @if (formDisabled()) {
          <button
            mat-raised-button
            class="action-button"
            (click)="editMode()"
            i18n="Edit button for forms"
          >
            Edit
          </button>
        } @else {
          @if (userAccount()?.enabled) {
            <button
              mat-stroked-button
              color="warn"
              (click)="enableAccount(false)"
              matTooltip="User will not be able to login again, no information will be lost"
              i18n="button to update disable a user"
            >
              Deactivate user
            </button>
          } @else {
            <button
              mat-raised-button
              color="accent"
              (click)="enableAccount(true)"
              matTooltip="User can login again with the previously used credentials"
              i18n="button to enable a user"
            >
              Activate user
            </button>
          }

          <button
            mat-raised-button
            color="accent"
            class="action-button"
            [disabled]="!form.valid || !form.dirty"
            (click)="save()"
            i18n="Save button for forms"
          >
            Save
          </button>
          <button
            mat-stroked-button
            class="action-button"
            (click)="cancel()"
            i18n="Cancel button for forms"
          >
            Cancel
          </button>
        }
      </div>
    }
  }

  @if (userAccount() && !userAccount()?.enabled) {
    <p i18n="Hint in user account page" class="field-hint field-warning">
      User is currently disabled and will not be able to login to the app
    </p>
  }

  <div class="user-details-form">
    <form [formGroup]="form">
      <mat-form-field class="full-width">
        <mat-label i18n="label of email input">Email</mat-label>
        <input matInput type="text" formControlName="email" />
        @if (getFormError("email", "email")) {
          <mat-error i18n> Please enter a valid email</mat-error>
        }
        @if (getFormError("email", "required")) {
          <mat-error i18n> This field is required</mat-error>
        }
        @if (isInDialog() && userAccount()?.userEntityId) {
          <mat-hint i18n="hint showing username/entity ID in dialog">
            Username: {{ userAccount()?.userEntityId }}
          </mat-hint>
        }
        @if (isProfileMode()) {
          <mat-hint i18n>
            Changing your email is temporarily only possible for administrators.
            Please contact your project coordinator or the support team.
          </mat-hint>
        }
      </mat-form-field>

      <mat-form-field class="full-width">
        <mat-label i18n="label of roles input">Roles</mat-label>
        <mat-select formControlName="roles" multiple>
          <mat-select-trigger>
            @for (role of form.get("roles")?.value; track role) {
              <span>{{ role.name }} </span>
            }
          </mat-select-trigger>
          @for (role of availableRoles.value(); track role) {
            <mat-option [value]="role" [matTooltip]="role.description">
              {{ role.description }}
              <em class="role-name">{{ role.name }}</em>
            </mat-option>
          }
        </mat-select>
        @if (getFormError("roles", "required")) {
          <mat-error i18n> This field is required</mat-error>
        }
        @if (!isInDialog()) {
          <mat-hint i18n>
            You should select at least one user role. Otherwise this user will
            not even be able to access the basic app layout like the menu.
          </mat-hint>
        }
      </mat-form-field>

      @if (showPasswordChange()) {
        <div class="field-row">
          <button
            mat-stroked-button
            type="button"
            color="primary"
            (click)="changePassword()"
            angulartics2On="click"
            angularticsCategory="User"
            angularticsAction="password_update"
            [disabled]="passwordChangeDisabled()"
            i18n="button to change password"
          >
            Change Password
          </button>
        </div>
      }

      <mat-form-field class="full-width">
        <mat-label i18n>Profile</mat-label>
        <app-edit-entity formControlName="userEntityId"></app-edit-entity>
        <mat-hint i18n>
          Editing linked profile record is not possible here. Please contact
          user support.
        </mat-hint>
      </mat-form-field>

      @if (getGlobalError()) {
        <mat-error class="global-error">{{ getGlobalError() }}</mat-error>
      }
    </form>
  </div>
</div>
