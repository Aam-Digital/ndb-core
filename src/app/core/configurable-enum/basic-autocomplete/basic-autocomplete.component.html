<mat-form-field>
  <!--
  This input contains the actual value, i.e. the id of the entity.
  It is filled in automatically in code after the user has chosen a correct value.
 -->
  <input matInput [formControl]="form" hidden/>

  <mat-label>{{ label }}</mat-label>

  <!--
  This input contains the display value (i.e. the value that the user chooses and sees when he clicks 'update')
  Which is the name of the entity in many cases.
  -->
  <input
    #inputElement
    id="inputElement"
    matInput
    [value]="selectedOption?.asString ?? ''"
    [disabled]="form.disabled"
    [matAutocomplete]="autoSuggestions"
    #trigger="matAutocompleteTrigger"
    (keyup)="updateAutocomplete(inputElement.value)"
    (focusin)="updateAutocomplete('')"
  />
  <fa-icon
    *ngIf="showWrench"
    icon="wrench"
    class="caret-suffix"
    [ngClass]="{ disabled: form.disabled }"
    matSuffix
    (click)="wrenchClick.emit()"
  ></fa-icon>

  <fa-icon
    icon="caret-down"
    class="caret-suffix"
    [ngClass]="{ disabled: form.disabled }"
    (click)="updateAutocomplete(''); inputElement.focus()"
    matSuffix
  ></fa-icon>

  <mat-autocomplete
    #autoSuggestions="matAutocomplete"
    (optionSelected)="select($event.option.value)"
    autoActiveFirstOption
  >
    <mat-option
      *ngFor="let item of autocompleteSuggestedOptions | async"
      [value]="item"
    >
      <mat-checkbox *ngIf="!item.selected"></mat-checkbox>
      <mat-checkbox *ngIf="item.selected" color="primary"></mat-checkbox>
      <ng-template
        [ngTemplateOutlet]="templateRef"
        [ngTemplateOutletContext]="{ $implicit: item.initial }"
      ></ng-template>
    </mat-option>
    <mat-option
      *ngIf="createOption && showAddOption && inputElement.value"
      [value]="inputElement.value"
    >
      <em>Add option</em> {{ inputElement.value }}
    </mat-option>
  </mat-autocomplete>

  <mat-error *ngIf="form.errors?.required" i18n="Error message for any input">
    This field is required
  </mat-error>
</mat-form-field>
