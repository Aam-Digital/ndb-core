name: Pull Request - Clean Up

on:
  pull_request_target:
    types: [closed]

permissions:
  contents: read
  actions: write  # required for deleting GitHub Actions caches
  packages: write  # required for deleting GHCR images

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  remove-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository files
        uses: actions/checkout@v4

      - name: Stop container and remove folder
        uses: appleboy/ssh-action@823bd89e131d8d508129f9443cad5855e9ba96f0 # v1.2.4
        continue-on-error: true
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /var/docker/pr-${{ github.event.number }}
            docker compose down
            cd ..
            rm -r pr-${{ github.event.number }}

      - name: Delete Docker Hub tag
        continue-on-error: true
        run: |
          token=$(curl -s -L 'https://hub.docker.com/v2/users/login' -H 'Content-Type: application/json' -d '{ "username": "${{ secrets.DOCKER_USERNAME }}", "password": "${{ secrets.DOCKER_PASSWORD }}"}')
          token=${token#*\"token\":\"}
          token=${token%%\"*}
          curl -s -L -X DELETE "https://hub.docker.com/v2/namespaces/aamdigital/repositories/ndb-server/tags/pr-${{ github.event.number }}" -H "Authorization: Bearer $token"

      - name: Delete GHCR image
        continue-on-error: true
        run: |
          PACKAGE_NAME="${{ github.event.repository.name }}"
          TAG="pr-${{ github.event.number }}"
          
          # Get the version ID for the specific tag
          VERSION_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/orgs/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME}/versions" \
            --jq ".[] | select(.metadata.container.tags[] == \"${TAG}\") | .id")
          
          if [ -n "$VERSION_ID" ]; then
            echo "Deleting GHCR image version $VERSION_ID with tag $TAG"
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              "/orgs/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME}/versions/${VERSION_ID}"
          else
            echo "No GHCR image found with tag $TAG"
          fi

      - name: Delete github caches for current branch
        run: |
          gh cache list -L 200 --ref "refs/pull/${{ github.event.number }}/merge" --json id --jq '.[] | .id' | while read -r id; do
            gh cache delete "$id"
          done
