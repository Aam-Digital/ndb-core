name: Pull Request - Update
# CI flow for pull requests: QA, build, and deploy preview

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

permissions:
  contents: read
  id-token: write  # required for _qa.yaml (QLTY code coverage)
  packages: write  # required for pushing to ghcr.io

env:
  BUILD_NAME: pr-${{ github.event.number }}

jobs:
  qa:
    uses: ./.github/workflows/_qa.yaml
    secrets: inherit
    with:
      skip-e2e: ${{ github.event.pull_request.draft }}

  build:
    uses: ./.github/workflows/_build.yaml
    secrets: inherit
    with:
      build_name: pr-${{ github.event.number }}
      docker_tags: type=ref,event=pr

  deploy:
    runs-on: ubuntu-latest
    needs:
      - build
    steps:
      - name: Deploy updated image
        uses: appleboy/ssh-action@823bd89e131d8d508129f9443cad5855e9ba96f0 # v1.2.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /var/docker/pr-${{ github.event.number }}
            docker compose pull
            docker compose up -d
