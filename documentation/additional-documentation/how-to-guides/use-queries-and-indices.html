<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>ndb-core documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../../images/favicon.ico">
	   <link rel="stylesheet" href="../../styles/style.css">
        <link rel="stylesheet" href="../../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>
          <script>
              // --- Iframe navigation tracking for Template Playground ---
              function sendCurrentUrlToParent() {
                  if (window.parent && window.parent !== window) {
                      window.parent.postMessage({
                          type: 'compodoc-iframe-navigate',
                          url: window.location.pathname + window.location.hash
                      }, '*');
                  }
              }
              window.addEventListener('hashchange', sendCurrentUrlToParent, false);
              window.addEventListener('popstate', sendCurrentUrlToParent, false);
              window.addEventListener('DOMContentLoaded', sendCurrentUrlToParent, false);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../../" class="navbar-brand">ndb-core documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content additional-page">
                   <div class="content-data">

























<h1>How to use queries and indices to get data</h1>
<p>The <a href="../../injectables/EntityMapperService.html">EntityMapperService</a> gives you an easy way to access
all entities of an Entity type or an individual entity by its ID (see <a href="load-and-save-data.html">Load and Save Data</a> for these basics).
However, for more advance features this will not be enough and you may need more powerful ways to load certain data.
This is where (persistent) queries come into play.</p>
<blockquote>
<p>The easiest workaround to get a specific set of entities is to load all entities of that type using the EntityMapperService
and then just use standard JavaScript/TypeScript to select the required entities.
With larger databases this is hitting its limitations however.</p>
</blockquote>
<h2>PouchDB Queries</h2>
<p>Our application is to some extent coupled with PouchDB/CouchDB.
As queries and database indexing is closely related to the underlying database this feature (at the moment)
directly refers to the underlying PouchDB feature.</p>
<p>Please read through the PouchDB documentation referring to map/reduce queries:
<a href="https://pouchdb.com/guides/queries.html">https://pouchdb.com/guides/queries.html</a></p>
<h2>Creating a persistent query / database index</h2>
<p>Before you can use <code>query</code> to load specific data you have to create the related &quot;design document&quot; for it in the PouchDB.</p>
<p>To do this, create a design document object according to the PouchDB documentation
and then use <code>saveDatabaseIndex</code> on the <a href="../../classes/Database.html">Database</a> service:</p>
<b>Example :</b><div><pre class="line-numbers"><code class="language-none">constructor(private db: Database) {}

private createQueryIndex() {
 const designDoc = {
   _id: &#39;_design/my_index&#39;,
   views: {
     by_child: {
       map: `(doc) =&gt; {
         if (!doc._id.startsWith(&quot;${ChildSchoolRelation.ENTITY_TYPE}&quot;)) return;
         emit(doc.childId);
         }`,
     },
   },
 };
 this.db.saveDatabaseIndex(designDoc);
}</code></pre></div><p>This is one of the rare cases where you will need to inject <code>Database</code> directly rather than only interacting with <code>EntityMapperService</code>.</p>
<p>Beware, unfortunately the <code>map:</code> function has to be a string containing the javascript function (to prevent the build optimization from messing this up).</p>
<h2>Loading data through a query</h2>
<p>After following above steps to <code>saveDatabaseIndex</code> that query is now available in the database.</p>
<p>You can now use this query to load data through its query id,
which is combined from the design document <code>_id</code> (without the &quot;_design/&quot; prefix) and the <code>views</code> key:</p>
<b>Example :</b><div><pre class="line-numbers"><code class="language-none">const result = await this.db.query(&#39;my_index/by_child&#39;, {key: childId, include_docs: true});</code></pre></div><p>Also note the additional options parameter with a <code>key</code> (the &quot;search value&quot;) and <code>include_docs</code> set to true.
The <code>query</code> function is a direct wrapper for PouchDB&#39;s <code>query</code> function, please refer to their docs for details.</p>
<p>As the query result is not automatically parsed by our EntityMapperService you have to map them manually:</p>
<b>Example :</b><div><pre class="line-numbers"><code class="language-none">let resultEntities: Note[];
resultEntities = result.rows.map(loadedRow =&gt; {
    const entity = new Note(&#39;&#39;);
    this.entitySchemaService.loadDataIntoEntity(entity, loadedRow.doc);
    return entity;
});</code></pre></div>
                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 2;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'additional-page';
            var COMPODOC_CURRENT_PAGE_URL = 'use-queries-and-indices.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../../js/libs/custom-elements.min.js"></script>
       <script src="../../js/libs/lit-html.js"></script>

       <script src="../../js/menu-wc.js" defer></script>
       <script nomodule src="../../js/menu-wc_es5.js" defer></script>

       <script src="../../js/libs/bootstrap-native.js"></script>

       <script src="../../js/libs/es6-shim.min.js"></script>
       <script src="../../js/libs/EventDispatcher.js"></script>
       <script src="../../js/libs/promise.min.js"></script>

       <script src="../../js/compodoc.js"></script>

       <script src="../../js/tabs.js"></script>
       <script src="../../js/menu.js"></script>
       <script src="../../js/libs/clipboard.min.js"></script>
       <script src="../../js/libs/prism.js"></script>
       <script src="../../js/sourceCode.js"></script>
          <script src="../../js/search/search.js"></script>
          <script src="../../js/search/lunr.min.js"></script>
          <script src="../../js/search/search-lunr.js"></script>
          <script src="../../js/search/search_index.js"></script>
       <script src="../../js/lazy-load-graphs.js"></script>


    </body>
</html>
